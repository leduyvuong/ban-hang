<% set_page_metadata(title: "Messages") %>

<%= turbo_stream_from [current_user, @conversation] %>

<div class="fixed inset-x-4 bottom-4 z-40 flex justify-end sm:inset-x-auto sm:right-6 sm:bottom-6">
  <div class="flex w-full max-w-5xl flex-col gap-4 sm:flex-row sm:items-end sm:justify-end">
    <div class="sm:hidden">
      <details class="group rounded-3xl bg-white/95 shadow-2xl ring-1 ring-slate-200 backdrop-blur">
        <summary class="flex cursor-pointer items-center justify-between rounded-3xl px-5 py-4 text-sm font-semibold text-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-teal-500">
          Conversations
          <svg class="h-4 w-4 text-slate-400 transition group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.25 8.27a.75.75 0 01-.02-1.06z" clip-rule="evenodd" />
          </svg>
        </summary>
        <div class="max-h-80 overflow-y-auto border-t border-slate-200/80">
          <%= render partial: "conversations/sidebar", locals: { conversations: @conversations, current_conversation: @conversation, wrapper_classes: "flex h-full flex-col bg-white/95" } %>
        </div>
      </details>
    </div>
    <aside class="hidden w-full max-w-sm sm:block">
      <%= render partial: "conversations/sidebar", locals: { conversations: @conversations, current_conversation: @conversation } %>
    </aside>
    <section class="flex w-full max-w-xl flex-col overflow-hidden rounded-3xl bg-white/95 shadow-2xl ring-1 ring-slate-200 backdrop-blur">
      <% other_user = @conversation.other_participant(current_user) || current_user %>
      <header class="flex items-center gap-3 border-b border-slate-200/80 px-6 py-4">
        <%= user_avatar_tag(other_user) %>
        <div>
          <h3 class="text-base font-semibold text-slate-900"><%= other_user.name %></h3>
          <p class="text-xs text-slate-500">Chat in real time and see messages instantly.</p>
        </div>
        <%= link_to conversations_path, class: "ml-auto hidden items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-medium text-slate-600 transition hover:border-teal-200 hover:text-teal-600 sm:flex" do %>
          <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M7.22 14.78a.75.75 0 001.06 0l4.5-4.5a.75.75 0 000-1.06l-4.5-4.5A.75.75 0 007.22 5.78L11.44 10l-4.22 4.22a.75.75 0 000 1.06z" clip-rule="evenodd" />
          </svg>
          Inbox
        <% end %>
      </header>
      <div class="flex-1 overflow-y-auto bg-slate-50/80" data-controller="scroll">
        <div id="messages_conversation_<%= @conversation.id %>" class="space-y-4 px-6 py-6">
          <% @messages.each do |message| %>
            <%= render partial: "messages/message", locals: { message: message, viewer: current_user } %>
          <% end %>
        </div>
      </div>
      <div class="border-t border-slate-200/80 bg-white/80 px-6 py-4">
        <%= render partial: "messages/form", locals: { conversation: @conversation, message: @message } %>
      </div>
    </section>
  </div>
</div>
