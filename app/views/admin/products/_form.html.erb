<%= form_with model: [:admin, @product], class: "space-y-6" do |form| %>
  <%= render "shared/form_errors", object: @product %>

  <div class="grid gap-5 lg:grid-cols-2">
    <div class="space-y-4">
      <div>
        <%= form.label :shop_id, "Shop", class: "text-sm font-semibold text-slate-700" %>
        <%= form.collection_select :shop_id, @shops, :id, :name, { prompt: "Select shop" }, class: "mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100 #{error_class(@product, :shop)}" %>
        <%= field_error(@product, :shop) %>
      </div>
      <div>
        <%= form.label :name, class: "text-sm font-semibold text-slate-700" %>
        <%= form.text_field :name, class: "mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100 #{error_class(@product, :name)}" %>
        <%= field_error(@product, :name) %>
      </div>
      <div>
        <%= form.label :short_description, class: "text-sm font-semibold text-slate-700" %>
        <%= form.text_field :short_description, class: "mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100 #{error_class(@product, :short_description)}" %>
        <p class="mt-1 text-xs text-slate-400">Appears in SEO snippets and cards (180 characters max).</p>
        <%= field_error(@product, :short_description) %>
      </div>
      <div>
        <%= form.label :category_id, "Category", class: "text-sm font-semibold text-slate-700" %>
        <%= form.collection_select :category_id, @categories, :id, :name, { include_blank: "Select category" }, class: "mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100" %>
      </div>
      <div class="grid gap-3 sm:grid-cols-[1fr_auto]">
        <div>
          <%= form.label :price_local_amount, "Price", class: "text-sm font-semibold text-slate-700" %>
          <%= form.number_field :price_local_amount, step: 0.01, min: 0, value: (@product.price_local_amount.presence || @product.price_in(current_currency)), class: "mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100 #{error_class(@product, :price_local_amount)}" %>
          <%= field_error(@product, :price_local_amount) %>
        </div>
        <div>
          <%= form.label :price_currency, "Currency", class: "text-sm font-semibold text-slate-700" %>
          <%= form.select :price_currency,
                available_currencies.map { |code| ["#{code}", code] },
                {},
                class: "mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100" %>
        </div>
        <p class="sm:col-span-2 text-xs text-slate-400">Prices are converted to <%= CurrencyRate::BASE_CURRENCY %> for internal calculations using the latest exchange rate.</p>
      </div>
      <div>
        <%= form.label :discount_id, "Discount", class: "text-sm font-semibold text-slate-700" %>
        <% selected_discount =
             if defined?(@selected_discount_id)
               @selected_discount_id == "" ? "" : @selected_discount_id.to_i
             else
               @product.discount&.id
             end %>
        <%= form.select :discount_id,
              options_for_select([["No discount", ""]] + @discounts.map { |discount| ["#{discount.name} (#{discount.formatted_value(currency: current_currency)})", discount.id] }, selected_discount),
              {},
              class: "mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100" %>
        <p class="mt-1 text-xs text-slate-400">Only active discounts appear here. Deactivate a discount to hide it.</p>
      </div>
      <div>
        <%= form.label :stock, class: "text-sm font-semibold text-slate-700" %>
        <%= form.number_field :stock, min: 0, class: "mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100 #{error_class(@product, :stock)}" %>
        <%= field_error(@product, :stock) %>
      </div>
      <div class="space-y-2">
        <%= form.label :image, "Product image", class: "text-sm font-semibold text-slate-700" %>
        <%= form.file_field :image, direct_upload: true, accept: "image/png,image/jpeg,image/jpg,image/webp", class: "block w-full rounded-2xl border border-dashed border-slate-300 bg-white px-4 py-6 text-sm text-slate-500 transition hover:border-indigo-400 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100" %>
        <% if @product.image.attached? %>
          <div class="flex items-center gap-4 rounded-2xl border border-slate-200 bg-slate-50 p-3">
            <div class="h-16 w-16 overflow-hidden rounded-xl bg-white">
              <%= image_tag @product.image_variant(width: 160, height: 160), alt: @product.name, class: "h-full w-full object-cover" %>
            </div>
            <label class="inline-flex items-center gap-2 text-sm text-slate-600">
              <%= form.check_box :remove_image, value: "1" %>
              <span>Remove current image</span>
            </label>
          </div>
        <% end %>
      </div>
    </div>

    <div>
      <%= form.label :description, class: "text-sm font-semibold text-slate-700" %>
      <%= form.text_area :description, rows: 10, class: "mt-1 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-100 #{error_class(@product, :description)}" %>
      <p class="mt-1 text-xs text-slate-400">Supports rich descriptions; use paragraphs for clarity.</p>
      <%= field_error(@product, :description) %>
    </div>
  </div>

  <div class="flex items-center gap-3">
    <%= form.submit @product.persisted? ? "Update product" : "Create product", class: "inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-500", data: { disable_with: "Saving..." } %>
    <%= link_to "Cancel", admin_products_path, class: "inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-indigo-200 hover:text-indigo-600" %>
  </div>
<% end %>
